# Abridge - Feature Implementation Status

This document lists all features in the Abridge pipeline with their **actual implementation status** as verified from the codebase.

Features are organized by tier, reflecting their position in the data dependency graph.

---

## Core Pipeline (Implemented)

The following capabilities are fully implemented:

| Feature | Status | Source File |
|---------|--------|-------------|
| Chapter-level condensation | ✅ Complete | `chapter_condensation.py` |
| Arc-level condensation | ✅ Complete | `arc_condensation.py` |
| Full novel condensation | ✅ Complete | `novel_condensation.py` |
| Model-agnostic LLM abstraction | ✅ Complete | `llm/llm_manager.py` |
| Recursive reduction for long novels | ✅ Complete | `utils.reduce_until_fit()` |
| Chapter prefiltering | ✅ Complete | `prefilter.py` |

---

## Tier-1 - Operational Features (Implemented)

These features provide visibility, safety, and cost control.

### 1. Resume / Skip Flags

**Status:** Implemented in `run_pipeline.py`

**Flags:**
- `--skip-chapters` - Reuse existing condensed chapters
- `--skip-arcs` - Reuse existing condensed arcs
- `--skip-novel` - Reuse existing novel condensation

**Behavior:**
- Skipping requires explicit flags AND valid existing outputs
- Validation checks output counts match input counts
- Invalid outputs raise errors (never silent continuation)
- Pipeline NEVER auto-skips based on file existence alone

---

### 2. Guardrails (Length Ratio Monitoring)

**Status:** Implemented in `guardrails.py`

**Metrics:**
- Compression ratio = output_length / input_length
- Classification: GREEN / YELLOW / RED

**Thresholds:**

| Stage | GREEN | YELLOW | RED |
|-------|-------|--------|-----|
| Chapter | 0.40-0.70 | 0.30-0.40 or 0.70-0.85 | <0.30 or >0.85 |
| Arc+ | 0.25-0.50 | 0.15-0.25 or 0.50-0.65 | <0.15 or >0.65 |

**Behavior:**
- Guardrails are OBSERVATIONAL ONLY - never block or modify output
- All events persisted to SQLite (`guardrail_events` table)
- Summary printed at end of run

---

### 3. Cost & Token Tracking

**Status:** Implemented in `cost_tracking.py`

**Metrics:**
- Input tokens per LLM call
- Output tokens per LLM call
- Estimated cost (USD) based on model pricing table

**Behavior:**
- All events persisted to SQLite (`llm_usage_events` table)
- Tracking failures do NOT halt pipeline
- Summary printed at end of run

**Pricing Coverage:**
- Gemini models
- DeepSeek
- Groq
- Cerebras
- OpenAI (via Copilot)
- Local models (Ollama, vLLM) - tracked as $0

---

### 4. Run Reports

**Status:** Implemented in `run_report.py`

**Outputs:**
- JSON: `data/reports/{run_id}.json`
- Markdown: `data/reports/{run_id}.md`

**Contents:**
- Run identity and timestamps
- LLM provider and model name
- Stage execution status (executed vs skipped)
- Guardrail summary (event counts, RED unit IDs)
- Cost summary (tokens, estimated cost)
- Output artifact paths

**Behavior:**
- Generated at end of every run (in finally block)
- NON-BLOCKING: report failures logged but do not halt pipeline

---

## Tier-2 - Structural Features (Implemented)

These features extract structure without interpretation.

### 5. Character Name Index

**Status:** Implemented in `character_indexing.py`

**CLI Flag:** `--character-index`

**Input:**
- Condensed chapter files from `data/chapters_condensed/{novel_name}/`

**Output:**
- `data/character_index/{novel_name}/{run_id}.character_index.json`

**Metrics per name:**
- `name`: verbatim string as it appears in text
- `mentions`: total occurrence count
- `first_seen`: chapter identifier of first appearance
- `chapters_present`: list of chapters where name appears
- `co_occurrences`: proximity-based co-occurrence counts (optional)

**Critical Scope Limits:**
- Names are RAW STRINGS, not resolved identities
- "Li Qiye" and "Young Master Li" are DIFFERENT entries
- NO alias resolution, NO coreference, NO role inference
- Statistics are SURFACE-LEVEL, not narrative importance

---

## Tier-3 - Derived Features (Implemented)

These features aggregate signals from Tier-2 and condensed text.

### 6. Character Salience (Tier-3.1)

**Status:** Implemented in `character_salience.py`

**CLI Flag:** `--character-salience`

**Dependencies:** Tier-2 Character Index

**Input:**
- `data/character_index/{novel_name}/{run_id}.character_index.json`

**Output:**
- `data/character_salience/{novel_name}/{run_id}.character_salience.json`

**Formula (weighted combination):**
- MENTION_WEIGHT = 0.5 (normalized frequency)
- COVERAGE_WEIGHT = 0.3 (chapter spread)
- PERSISTENCE_WEIGHT = 0.2 (early-to-late presence)

**Critical Scope Limits:**
- Salience measures TEXTUAL DOMINANCE, not narrative importance
- High salience does NOT mean "main character"
- Scores are relative within a single novel/run

---

### 7. Relationship Signal Matrix (Tier-3.2)

**Status:** Implemented in `relationship_matrix.py`

**CLI Flag:** `--relationship-matrix`

**Dependencies:** Tier-2 Character Index, Tier-3.1 Salience

**Input:**
- Character index JSON
- Character salience JSON

**Output:**
- `data/relationship_matrix/{novel_name}/{run_id}.relationship_matrix.json`

**Signals per character pair:**
- `co_presence_count`: chapters where both appear
- `co_presence_ratio`: co-presence / min(coverage)
- `jaccard_similarity`: intersection / union of chapters
- `persistence_score`: composite score for distributed co-presence

**Configuration:**
- `SALIENCE_THRESHOLD = 0.1` (minimum salience to include in pairing)
- `MINIMUM_CO_PRESENCE = 1` (at least one shared chapter required)

**Critical Scope Limits:**
- Co-presence is STRUCTURAL, not semantic
- High persistence does NOT mean "close relationship"
- NO relationship type inference

---

### 8. Event Keyword Surface Map (Tier-3.3)

**Status:** Implemented in `event_keywords.py`

**CLI Flag:** `--event-keywords`

**Dependencies:** Condensed chapters (no Tier-2 dependency)

**Input:**
- Condensed chapter files from `data/chapters_condensed/{novel_name}/`

**Output:**
- `data/event_keywords/{novel_name}/{run_id}.event_keywords.json`

**Keyword Dictionary Categories:**
- Transmigration (reincarnation, regression, second_chance)
- System (system_awakening, level_up, skill_acquisition)
- Cultivation (breakthrough, enlightenment, tribulation)

**Signals per keyword:**
- `mentions`: total count across all chapters
- `first_seen_unit`: index of first chapter with keyword
- `last_seen_unit`: index of last chapter with keyword
- `narrative_spread`: span in chapters
- `density`: mentions / total_chapters

**Critical Scope Limits:**
- Keyword presence does NOT equal event confirmation
- High frequency does NOT equal narrative importance
- Matching is LEXICAL, not semantic

---

### 9. Genre Resolver (Tier-3.4a)

**Status:** Implemented in `genre_resolver.py`

**CLI Flag:** `--genre-resolver`

**Dependencies:** Tier-3.1 Salience, Tier-3.2 Relationships, Tier-3.3 Event Keywords

**Input:**
- `data/character_salience/{novel_name}/{run_id}.character_salience.json`
- `data/relationship_matrix/{novel_name}/{run_id}.relationship_matrix.json`
- `data/event_keywords/{novel_name}/{run_id}.event_keywords.json`

**Output:**
- `data/genre_resolved/{novel_name}/{run_id}.genre_resolved.json`

**Genre Taxonomy (partial list):**
- Xianxia, Xuanhuan, Wuxia, Martial Arts
- Isekai, Reincarnation
- (Full list in `genre_resolver.py`)

**Rule Model:**
- Required evidence (hard gate)
- Supporting evidence (boosts)
- Penalties (reductions)
- `CONFIDENCE_THRESHOLD = 0.3`

**Critical Scope Limits:**
- NO LLM usage - purely rule-based
- Multiple genres can have high confidence
- Low confidence = insufficient evidence, not "definitely not this genre"

---

### 10. Tag Resolver (Tier-3.4b)

**Status:** Implemented in `tag_resolver.py`

**CLI Flag:** `--tag-resolver`

**Dependencies:** Tier-3.1 through Tier-3.4a

**Input:**
- All Tier-3 artifacts
- Genre resolution output

**Output:**
- `data/tag_resolved/{novel_name}/{run_id}.tag_resolved.json`

**Tag Taxonomy (partial list):**
- Reincarnation, Age Regression, Body Swap
- (Full list in `tag_resolver.py`)

**Rule Model:** Same as Genre Resolver (required/supporting/penalties)

**Critical Scope Limits:**
- Only tags with DETECTABLE EVIDENCE are implemented
- Tags requiring subjective interpretation are EXCLUDED
- NO LLM usage

---

## Explicit Non-Goals

The following features are intentionally excluded:

- Quality scoring
- Recommendation ranking
- Sentiment analysis
- Moral judgment
- Author intent inference
- Protagonist identification (beyond surface frequency)
- Relationship type inference
- Scene detection
- POV detection

---

## Feature Dependency Graph

```
[Raw Chapters]
       |
       v
[Stage 1: Chapter Condensation] ----------------------+
       |                                              |
       v                                              |
[Stage 2: Arc Condensation]                          |
       |                                              |
       v                                              |
[Stage 3: Novel Condensation]                        |
                                                      |
                                                      v
                                          [Tier-2: Character Index]
                                                      |
                              +-----------------------+-----------------------+
                              v                       v                       |
                   [Tier-3.1: Salience]    [Tier-3.3: Event Keywords]         |
                              |                       |                       |
                              v                       |                       |
                   [Tier-3.2: Relationships] ---------+                       |
                              |                       |                       |
                              v                       v                       |
                   [Tier-3.4a: Genre Resolver] <------+                       |
                              |                                               |
                              v                                               |
                   [Tier-3.4b: Tag Resolver] <--------------------------------+
```

---

## Design Principle Reminder

Abridge is an **editorial condensation engine**, not a review system.

All features preserve:
- Narrative fidelity
- Neutral tone
- Deterministic behavior
- Reader autonomy
